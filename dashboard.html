<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <title>Dashboard</title>
    <link rel="stylesheet" href="./css/site.css" />
  </head>
  <body>
    <div class="header">
      <div class="toggle">
        <a id="toggle-nav"><i class="fa fa-navicon cog"></i></a>
      </div>
    </div>
    <div class="container">
      <div class="sidebar" id="sidebar">
        <a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a>
        <a href="form.html"><i class="fa fa-shopping-cart"></i> Forms</a>
        <a href="tables.html"><i class="fa fa-shopping-bag"></i> Tables</a>
      </div>
      <div class="content">
        <div class="summary-container">
          <div class="summary">
            <div class="summary-icon"><i class="fa fa-users"></i></div>
            <div class="summary-content">
              <div class="summary-heading">Users</div>
               <div><h2 id="users-count">0</h2></div>
            </div>
          </div>
          <div class="summary">
            <div class="summary-icon"><i class="fa fa-signal"></i></div>
            <div class="summary-content">
              <div class="summary-heading">Products</div>
               <div><h2 id="products-count">0</h2></div>
            </div>
          </div>
          <div class="summary">
            <div class="summary-icon"><i class="fa fa-shopping-cart"></i></div>
            <div class="summary-content">
              <div class="summary-heading">Sales</div>
               <div><h2 id="sales-count">0</h2></div>
            </div>
          </div>
          <div class="summary">
            <div class="summary-icon"><i class="fa fa-line-chart"></i></div>
            <div class="summary-content">
              <div class="summary-heading">Profit</div>
               <div><h2 id="profit-count">0</h2></div>
            </div>
          </div>
        </div>
        
       
        <div class="charts-container">
         
          <div class="chart-card">
            <div class="chart-title">Sold Products Distribution</div>
            <div class="chart-container">
              <div class="loading" id="pie-loading">Loading chart...</div>
              <canvas id="pieChart" style="display:none;"></canvas>
            </div>
          </div>
          
          
          <div class="chart-card">
            <div class="chart-title">Top Products</div>
            <div class="chart-container">
              <div class="loading" id="bar-loading">Loading chart...</div>
              <canvas id="barChart" style="display:none;"></canvas>
            </div>
          </div>
          
          
          <div class="chart-card">
            <div class="chart-title">Visitors Over Time</div>
            <div class="chart-container">
              <div class="loading" id="line-loading">Loading chart...</div>
              <canvas id="lineChart" style="display:none;"></canvas>
            </div>
          </div>
          
         
          <div class="chart-card">
            <div class="chart-title">Sales Analysis</div>
            <div class="chart-container">
              <div class="loading" id="scatter-loading">Loading chart...</div>
              <canvas id="scatterChart" style="display:none;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
               
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(() => {
       
        $("#toggle-nav").on("click", () => {
          $("#sidebar").toggleClass("hidden");
        });
        
       
        loadDashboardStats();
        
       
        loadDataAndRenderCharts();
      });
      
      
      function loadDashboardStats() {
        $("#users-count, #products-count, #sales-count, #profit-count").text("Loading...");
        fetch("http://localhost:3000/statistics")
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
          })
          .then(data => {
            console.log("Dashboard stats:", JSON.stringify(data, null, 2));
            $("#users-count").text(data.users || 0);
            $("#products-count").text(data.products || 0);
            $("#sales-count").text(data.sales || 0);
            $("#profit-count").text(data.profit || 0);
          })
          .catch(err => {
            console.error("Error fetching dashboard stats:", err);
            $("#users-count, #products-count, #sales-count, #profit-count").text("Error");
          });
      }
      
      async function loadDataAndRenderCharts() {
        try {
         
          $("#pie-loading").html('<div class="loader"></div>');
          let pieData;
          try {
            const res = await fetch("http://localhost:3000/sold_products");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            pieData = await res.json();
            console.log("Pie chart data:", JSON.stringify(pieData, null, 2));
            if (!Array.isArray(pieData)) throw new Error("Invalid data: Expected array");
            const pieLabels = pieData.map(item => item.product || item.name || "Unknown");
            const pieValues = pieData.map(item => item.quantity ?? item.amount ?? 0);
            if (pieValues.every(val => val === 0)) {
              console.warn("Pie chart: No valid data, using mock data");
              pieData = [
                { product: "Item A", quantity: 30 },
                { product: "Item B", quantity: 50 },
                { product: "Item C", quantity: 20 }
              ];
            }
          } catch (err) {
            console.error("Error loading pie chart:", err);
            pieData = [
              { product: "Item A", quantity: 30 },
              { product: "Item B", quantity: 50 },
              { product: "Item C", quantity: 20 }
            ];
          }
          setTimeout(() => {
            $("#pie-loading").hide();
            $("#pieChart").show();
            const ctx = document.getElementById('pieChart').getContext('2d');
            new Chart(ctx, {
              type: 'pie',
              data: {
                labels: pieData.map(item => item.product || item.name || "Unknown"),
                datasets: [{
                  data: pieData.map(item => item.quantity ?? item.amount ?? 0),
                  backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#34495e', '#e67e22'],
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                legend: {
                  position: 'bottom',
                  labels: { fontColor: '#333' }
                }
              }
            });
          }, 3000);
          
          
          $("#bar-loading").html('<div class="loader"></div>');
          let barData;
          try {
            const res = await fetch("http://localhost:3000/top_products");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            barData = await res.json();
            console.log("Bar chart data:", JSON.stringify(barData, null, 2));
            if (!Array.isArray(barData)) throw new Error("Invalid data: Expected array");
            const barLabels = barData.map(item => item.product || item.name || "Unknown");
            const barValues = barData.map(item => item.sales ?? item.value ?? 0);
            if (barValues.every(val => val === 0)) {
              console.warn("Bar chart: No valid data, using mock data");
              barData = [
                { product: "Item A", sales: 100 },
                { product: "Item B", sales: 200 },
                { product: "Item C", sales: 150 }
              ];
            }
          } catch (err) {
            console.error("Error loading bar chart:", err);
            barData = [
              { product: "Item A", sales: 100 },
              { product: "Item B", sales: 200 },
              { product: "Item C", sales: 150 }
            ];
          }
          setTimeout(() => {
            $("#bar-loading").hide();
            $("#barChart").show();
            const ctx = document.getElementById('barChart').getContext('2d');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: barData.map(item => item.product || item.name || "Unknown"),
                datasets: [{
                  label: 'Sales',
                  data: barData.map(item => item.sales ?? item.value ?? 0),
                  backgroundColor: '#3498db',
                  borderColor: '#2980b9',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  yAxes: [{
                    ticks: { beginAtZero: true, fontColor: '#333' },
                    gridLines: { color: '#ddd' }
                  }],
                  xAxes: [{
                    ticks: { fontColor: '#333' },
                    gridLines: { display: false }
                  }]
                },
                legend: { labels: { fontColor: '#333' } }
              }
            });
          }, 3000);
          
          
          $("#line-loading").html('<div class="loader"></div>');
          let lineData;
          try {
            const res = await fetch("http://localhost:3000/visitors");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            lineData = await res.json();
            console.log("Line chart data:", JSON.stringify(lineData, null, 2));
            if (!Array.isArray(lineData)) throw new Error("Invalid data: Expected array");
            const lineLabels = lineData.map(item => item.date || item.time || "Unknown");
            const lineValues = lineData.map(item => item.visitors ?? item.count ?? 0);
            if (lineValues.every(val => val === 0)) {
              console.warn("Line chart: No valid data, using mock data");
              lineData = [
                { date: "2023-01", visitors: 100 },
                { date: "2023-02", visitors: 150 },
                { date: "2023-03", visitors: 200 }
              ];
            }
          } catch (err) {
            console.error("Error loading line chart:", err);
            lineData = [
              { date: "2023-01", visitors: 100 },
              { date: "2023-02", visitors: 150 },
              { date: "2023-03", visitors: 200 }
            ];
          }
          setTimeout(() => {
            $("#line-loading").hide();
            $("#lineChart").show();
            const ctx = document.getElementById('lineChart').getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: lineData.map(item => item.date || item.time || "Unknown"),
                datasets: [{
                  label: 'Visitors',
                  data: lineData.map(item => item.visitors ?? item.count ?? 0),
                  borderColor: '#2ecc71',
                  backgroundColor: 'rgba(46, 204, 113, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  yAxes: [{
                    ticks: { beginAtZero: true, fontColor: '#333' },
                    gridLines: { color: '#ddd' }
                  }],
                  xAxes: [{
                    ticks: { fontColor: '#333' },
                    gridLines: { display: false }
                  }]
                },
                legend: { labels: { fontColor: '#333' } }
              }
            });
          }, 3000);
          
          
          $("#scatter-loading").html('<div class="loader"></div>');
          let scatterData;
          try {
            const res = await fetch("http://localhost:3000/sales");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            scatterData = await res.json();
            console.log("Scatter chart data:", JSON.stringify(scatterData, null, 2));
            if (!Array.isArray(scatterData) || !scatterData.every(item => typeof item.x === 'number' && typeof item.y === 'number')) {
              throw new Error("Invalid data: Expected array of {x: number, y: number}");
            }
          } catch (err) {
            console.error("Error loading scatter chart:", err);
            scatterData = [
              { x: 10, y: 20 },
              { x: 15, y: 25 },
              { x: 20, y: 15 }
            ];
          }
          setTimeout(() => {
            $("#scatter-loading").hide();
            $("#scatterChart").show();
            const ctx = document.getElementById('scatterChart').getContext('2d');
            new Chart(ctx, {
              type: 'scatter',
              data: {
                datasets: [{
                  label: 'Sales Data',
                  data: scatterData.map(item => ({ x: item.x, y: item.y })),
                  backgroundColor: '#e74c3c',
                  borderColor: '#c0392b',
                  borderWidth: 1,
                  pointRadius: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  xAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    ticks: { fontColor: '#333' },
                    gridLines: { color: '#ddd' }
                  }],
                  yAxes: [{
                    ticks: { beginAtZero: true, fontColor: '#333' },
                    gridLines: { color: '#ddd' }
                  }]
                },
                legend: { labels: { fontColor: '#333' } }
              }
            });
          }, 3000);
          
          
          $("#bubble-loading").html('<div class="loader"></div>');
          let bubbleData;
          try {
            const res = await fetch("http://localhost:3000/engagement");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            bubbleData = await res.json();
            console.log("Bubble chart data:", JSON.stringify(bubbleData, null, 2));
            if (!Array.isArray(bubbleData) || !bubbleData.every(item => typeof item.x === 'number' && typeof item.y === 'number' && typeof item.r === 'number')) {
              throw new Error("Invalid data: Expected array of {x: number, y: number, r: number}");
            }
          } catch (err) {
            console.error("Error loading bubble chart:", err);
            bubbleData = [
              { x: 10, y: 20, r: 15 },
              { x: 15, y: 25, r: 10 },
              { x: 20, y: 15, r: 20 }
            ];
          }
          setTimeout(() => {
            $("#bubble-loading").hide();
            $("#bubbleChart").show();
            const ctx = document.getElementById('bubbleChart').getContext('2d');
            new Chart(ctx, {
              type: 'bubble',
              data: {
                datasets: [{
                  label: 'User Engagement Metrics',
                  data: bubbleData,
                  backgroundColor: 'rgba(46, 204, 113, 0.3)',
                  borderColor: 'rgba(46, 204, 113, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  xAxes: [{
                    ticks: { fontColor: '#333' },
                    gridLines: { color: '#ddd' },
                    scaleLabel: { display: true, labelString: 'Time Spent (min)' }
                  }],
                  yAxes: [{
                    ticks: { fontColor: '#333' },
                    gridLines: { color: '#ddd' },
                    scaleLabel: { display: true, labelString: 'Interactions' }
                  }]
                },
                legend: { labels: { fontColor: '#333' } }
              }
            });
          }, 3000);
          
          
          $("#area-loading").html('<div class="loader"></div>');
          let areaData;
          try {
            const res = await fetch("http://localhost:3000/revenue");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            areaData = await res.json();
            console.log("Area chart data:", JSON.stringify(areaData, null, 2));
            if (!areaData.dates || !Array.isArray(areaData.dates) || !areaData.amounts || !Array.isArray(areaData.amounts)) {
              throw new Error("Invalid data: Expected {dates: string[], amounts: number[]}");
            }
          } catch (err) {
            console.error("Error loading area chart:", err);
            areaData = {
              dates: ["2023-01", "2023-02", "2023-03"],
              amounts: [1000, 1500, 2000]
            };
          }
          setTimeout(() => {
            $("#area-loading").hide();
            $("#areaChart").show();
            const ctx = document.getElementById('areaChart').getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: areaData.dates,
                datasets: [{
                  label: 'Revenue Over Time',
                  data: areaData.amounts,
                  backgroundColor: 'rgba(52, 152, 219, 0.3)',
                  borderColor: 'rgba(52, 152, 219, 1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  yAxes: [{
                    ticks: { beginAtZero: true, fontColor: '#333' },
                    gridLines: { color: '#ddd' },
                    scaleLabel: { display: true, labelString: 'Revenue ($)' }
                  }],
                  xAxes: [{
                    ticks: { fontColor: '#333' },
                    gridLines: { display: false },
                    scaleLabel: { display: true, labelString: 'Date' }
                  }]
                },
                legend: { position: 'top', labels: { fontColor: '#333' } }
              }
            });
          }, 3000);
          
         
          $("#doughnut-loading").html('<div class="loader"></div>');
          let doughnutData;
          try {
            const res = await fetch("http://localhost:3000/market_share");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            doughnutData = await res.json();
            console.log("Doughnut chart data:", JSON.stringify(doughnutData, null, 2));
            if (!doughnutData.segments || !Array.isArray(doughnutData.segments) || !doughnutData.values || !Array.isArray(doughnutData.values)) {
              throw new Error("Invalid data: Expected {segments: string[], values: number[]}");
            }
          } catch (err) {
            console.error("Error loading doughnut chart:", err);
            doughnutData = {
              segments: ["Segment A", "Segment B", "Segment C"],
              values: [30, 40, 30]
            };
          }
          setTimeout(() => {
            $("#doughnut-loading").hide();
            $("#doughnutChart").show();
            const ctx = document.getElementById('doughnutChart').getContext('2d');
            new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: doughnutData.segments,
                datasets: [{
                  data: doughnutData.values,
                  backgroundColor: [
                    'rgba(231, 76, 60, 0.3)',
                    'rgba(241, 196, 15, 0.3)',
                    'rgba(26, 188, 156, 0.3)',
                    'rgba(46, 204, 113, 0.3)',
                    'rgba(155, 89, 182, 0.3)'
                  ],
                  borderColor: [
                    'rgba(231, 76, 60, 1)',
                    'rgba(241, 196, 15, 1)',
                    'rgba(26, 188, 156, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(155, 89, 182, 1)'
                  ],
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                legend: {
                  position: 'right',
                  labels: { fontColor: '#333' }
                }
              }
            });
          }, 3000);
          
          
          $("#horizontalBar-loading").html('<div class="loader"></div>');
          let horizontalBarData;
          try {
            const res = await fetch("http://localhost:3000/performance");
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            horizontalBarData = await res.json();
            console.log("Horizontal bar chart data:", JSON.stringify(horizontalBarData, null, 2));
            if (!horizontalBarData.products || !Array.isArray(horizontalBarData.products) || !horizontalBarData.scores || !Array.isArray(horizontalBarData.scores)) {
              throw new Error("Invalid data: Expected {products: string[], scores: number[]}");
            }
          } catch (err) {
            console.error("Error loading horizontal bar chart:", err);
            horizontalBarData = {
              products: ["Product A", "Product B", "Product C"],
              scores: [80, 90, 85]
            };
          }
          setTimeout(() => {
            $("#horizontalBar-loading").hide();
            $("#horizontalBarChart").show();
            const ctx = document.getElementById('horizontalBarChart').getContext('2d');
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: horizontalBarData.products,
                datasets: [{
                  label: 'Product Performance Score',
                  data: horizontalBarData.scores,
                  backgroundColor: 'rgba(230, 126, 34, 0.3)',
                  borderColor: 'rgba(230, 126, 34, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  xAxes: [{
                    ticks: { beginAtZero: true, fontColor: '#333' },
                    gridLines: { color: '#ddd' },
                    scaleLabel: { display: true, labelString: 'Performance Score' }
                  }],
                  yAxes: [{
                    ticks: { fontColor: '#333' },
                    gridLines: { display: false }
                  }]
                },
                legend: { labels: { fontColor: '#333' } },
                tooltips: {
                  callbacks: {
                    label: function(tooltipItem, data) {
                      return `${data.datasets[tooltipItem.datasetIndex].label}: ${tooltipItem.xLabel}`;
                    }
                  }
                }
              }
            });
          }, 3000);
        } catch (err) {
          console.error("Error in loadDataAndRenderCharts:", err);
        }
      }
    </script>
  </body>
</html>